<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Captioner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --bg-cream: #F5F3EE;
            --bg-white: #FFFFFF;
            --green-primary: #3D5A47;
            --green-light: #4A6B52;
            --green-bright: #00A676;
            --green-bar-1: #3D5A47;
            --green-bar-2: #6B9B76;
            --text-dark: #3D5A47;
            --text-medium: #5A6B5E;
            --text-light: #8A9A8E;
            --border-light: #D4D2CD;
            --border-card: #E0DED9;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-cream);
            color: var(--text-dark);
            line-height: 1.5;
            min-height: 100vh;
        }

        body.overlay-mode { background: transparent; overflow: hidden; }

        .app-container { max-width: 920px; margin: 0 auto; padding: 20px; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 12px 0; }
        .logo { display: flex; align-items: center; gap: 16px; }
        .logo-mark { display: flex; flex-direction: column; gap: 5px; }
        .logo-bar { height: 8px; border-radius: 4px; width: 56px; }
        .logo-bar-1 { background: var(--green-bar-1); }
        .logo-bar-2 { background: var(--green-bar-2); }
        .logo-text { font-weight: 700; font-size: 24px; color: var(--text-dark); line-height: 1.1; }
        .logo-text span { display: block; }
        .cc-badge { display: inline-flex; align-items: center; border: 2px solid var(--text-dark); border-radius: 5px; padding: 3px 8px; font-size: 14px; font-weight: 700; margin-left: 8px; }

        .header-right { display: flex; align-items: center; gap: 20px; }
        .big-logo { height: 50px; width: auto; }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .status-pill { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 500; color: var(--text-medium); }
        .status-dot { width: 28px; height: 16px; background: var(--green-primary); border-radius: 8px; position: relative; }
        .status-dot::after { content: ''; position: absolute; right: 2px; top: 2px; width: 12px; height: 12px; background: white; border-radius: 50%; }
        .status-dot.inactive { background: var(--border-light); }
        .status-dot.inactive::after { right: auto; left: 2px; }

        .popout-btn { display: flex; align-items: center; gap: 5px; padding: 6px 12px; background: var(--bg-white); border: 1px solid var(--border-card); border-radius: var(--radius-sm); font-family: inherit; font-size: 12px; font-weight: 500; color: var(--text-medium); cursor: pointer; }
        .popout-btn:hover { border-color: var(--green-primary); color: var(--green-primary); }

        /* Channel Badge */
        .channel-badge { display: flex; align-items: center; gap: 8px; background: var(--green-primary); color: white; padding: 6px 12px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; }
        .channel-badge code { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; letter-spacing: 1px; }
        .channel-badge.error { background: #DC3545; }
        .channel-badge.warning { background: #F59E0B; }

        /* Interactive Steps */
        .steps-container { display: flex; gap: 16px; margin-bottom: 16px; }
        .step-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 20px 16px; background: var(--bg-white); border: 2px solid var(--border-card); border-radius: var(--radius-lg); cursor: pointer; transition: all 0.2s; text-align: center; }
        .step-btn:hover { border-color: var(--green-primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .step-btn.completed { border-color: var(--green-bright); background: #F0F9F4; }
        .step-btn.active { border-color: var(--green-primary); box-shadow: 0 0 0 3px rgba(61, 90, 71, 0.15); }
        .step-num-circle { width: 36px; height: 36px; background: var(--green-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; }
        .step-btn.completed .step-num-circle { background: var(--green-bright); }
        .step-btn.completed .step-num-circle::after { content: '✓'; }
        .step-btn.completed .step-num-circle span { display: none; }
        .step-title { font-weight: 600; font-size: 15px; color: var(--text-dark); }
        .step-desc { font-size: 12px; color: var(--text-light); line-height: 1.4; }
        .step-action { margin-top: 6px; padding: 8px 16px; background: var(--green-primary); color: white; border: none; border-radius: var(--radius-sm); font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .step-action:hover { background: var(--green-light); }
        .step-btn.completed .step-action { background: var(--green-bright); }

        /* URL Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .modal { background: white; border-radius: var(--radius-lg); padding: 28px; max-width: 520px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-light); line-height: 1; }
        .modal-close:hover { color: var(--text-dark); }
        .url-option { background: var(--bg-cream); border: 2px solid var(--border-card); border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; }
        .url-option:hover { border-color: var(--green-primary); }
        .url-option.selected { border-color: var(--green-primary); background: #F0F9F4; }
        .url-option-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .url-option-icon { width: 32px; height: 32px; background: var(--green-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .url-option.selected .url-option-icon { background: var(--green-bright); }
        .url-option-title { font-weight: 600; font-size: 15px; }
        .url-option-badge { font-size: 10px; background: var(--green-bright); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
        .url-option-desc { font-size: 13px; color: var(--text-medium); padding-left: 42px; }
        .url-option-url { margin-top: 10px; padding: 10px 12px; background: white; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-family: 'Monaco', 'Menlo', monospace; font-size: 11px; color: var(--text-dark); word-break: break-all; }
        .modal-copy-btn { width: 100%; padding: 14px; background: var(--green-primary); color: white; border: none; border-radius: var(--radius-md); font-family: inherit; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 8px; }
        .modal-copy-btn:hover { background: var(--green-light); }
        .modal-copy-btn:disabled { background: var(--border-light); cursor: not-allowed; }
        .modal-copy-btn.copied { background: var(--green-bright); }
        .modal-note { font-size: 12px; color: var(--text-light); text-align: center; margin-top: 12px; }
        .modal-note strong { color: var(--green-primary); }

        /* Preview */
        .preview-area { background: #E8E6E1; border-radius: var(--radius-lg); padding: 40px 24px; margin-bottom: 20px; min-height: 160px; display: flex; align-items: center; justify-content: center; position: relative; border: 1px solid var(--border-card); }
        .preview-label { position: absolute; top: 10px; left: 14px; font-size: 10px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        .preview-text { font-size: 24px; font-weight: 500; color: #333; text-align: center; line-height: 1.3; padding: 12px 24px; border-radius: 8px; max-width: 90%; }
        .preview-text.placeholder { color: var(--text-light); font-size: 18px; background: transparent !important; }

        /* Cards */
        .cards-container { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
        .card { background: var(--bg-white); border: 1px solid var(--border-card); border-radius: var(--radius-lg); padding: 18px; }
        .card.full-width { grid-column: 1 / -1; }
        .card-title { font-size: 15px; font-weight: 600; color: var(--text-dark); margin-bottom: 14px; }

        /* Form */
        .form-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .form-row:last-child { margin-bottom: 0; }
        .form-label { font-size: 13px; color: var(--text-medium); }
        .slider-container { display: flex; align-items: center; gap: 8px; }
        .slider { width: 90px; height: 4px; -webkit-appearance: none; background: var(--border-light); border-radius: 2px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--text-dark); border-radius: 50%; cursor: pointer; }
        .slider-value { min-width: 38px; padding: 5px 8px; background: var(--bg-cream); border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-size: 12px; font-weight: 500; text-align: center; }
        .color-picker { width: 32px; height: 32px; border: none; border-radius: var(--radius-sm); cursor: pointer; padding: 0; }
        .color-picker::-webkit-color-swatch-wrapper { padding: 0; }
        .color-picker::-webkit-color-swatch { border: 2px solid var(--border-light); border-radius: var(--radius-sm); }

        .btn-group { display: flex; gap: 2px; background: var(--bg-cream); padding: 2px; border-radius: var(--radius-sm); }
        .btn-group-item { width: 30px; height: 26px; border: none; background: transparent; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-medium); font-size: 12px; transition: all 0.15s; }
        .btn-group-item:hover { background: var(--bg-white); }
        .btn-group-item.active { background: var(--green-primary); color: white; }

        /* Audio */
        .audio-select { width: 100%; padding: 9px 12px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-family: inherit; font-size: 12px; color: var(--text-dark); background: var(--bg-cream); cursor: pointer; margin-bottom: 12px; }
        .action-btn { width: 100%; padding: 11px 18px; border: none; border-radius: var(--radius-md); font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; }
        .action-btn.start { background: var(--green-primary); color: white; }
        .action-btn.start:hover { background: var(--green-light); }
        .action-btn.stop { background: #DC3545; color: white; }
        .clear-btn { width: 100%; padding: 8px; margin-top: 8px; border: 1px solid var(--border-light); background: transparent; border-radius: var(--radius-sm); font-family: inherit; font-size: 12px; color: var(--text-medium); cursor: pointer; }
        .audio-info { color: var(--text-light); font-size: 11px; margin-top: 10px; line-height: 1.4; }

        /* FAQ */
        .faq-section { margin-top: 24px; margin-bottom: 8px; }
        .faq-title { font-size: 20px; font-weight: 700; color: var(--text-dark); margin-bottom: 16px; text-align: center; }
        .faq-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .faq-item { background: var(--bg-white); border: 1px solid var(--border-card); border-radius: var(--radius-lg); padding: 18px; }
        .faq-question { font-weight: 600; font-size: 14px; color: var(--text-dark); margin-bottom: 8px; display: flex; align-items: flex-start; gap: 8px; }
        .faq-question::before { content: 'Q'; background: var(--green-primary); color: white; min-width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
        .faq-answer { font-size: 13px; color: var(--text-medium); line-height: 1.6; padding-left: 28px; }

        /* Footer */
        .footer { text-align: center; padding: 32px 20px; color: var(--text-medium); font-size: 16px; line-height: 1.8; border-top: 1px solid var(--border-light); margin-top: 24px; }
        .footer a { color: var(--green-primary); text-decoration: none; font-weight: 500; }
        .footer a:hover { text-decoration: underline; }
        .footer-links { margin-top: 14px; display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; }
        .footer-link { display: flex; align-items: center; gap: 6px; font-size: 15px; }

        @media (max-width: 700px) {
            .cards-container { grid-template-columns: 1fr; }
            .faq-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 12px; align-items: flex-start; }
            .header-right { width: 100%; justify-content: space-between; }
            .steps-container { flex-direction: column; }
            .step-btn { flex-direction: row; padding: 16px; gap: 14px; text-align: left; }
            .step-btn .step-desc { display: none; }
            .slider { width: 60px; }
            .big-logo { height: 40px; }
        }

        .overlay-container { width: 1920px; height: 1080px; position: relative; }
        .caption-display { position: absolute; width: 100%; padding: 20px 60px; display: flex; justify-content: center; z-index: 10000; }
        .caption-text-overlay { word-wrap: break-word; line-height: 1.4; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ============================================================
        // FIREBASE CONFIG - Replace with your values from Firebase Console
        // See FIREBASE-SETUP.md for instructions
        // ============================================================
        var FIREBASE_CONFIG = {
             apiKey: "AIzaSyAss0ba7qp8894GpFNz8h5wPM83UzdMldI",
  authDomain: "community-captioner.firebaseapp.com",
  projectId: "community-captioner",
  storageBucket: "community-captioner.firebasestorage.app",
  messagingSenderId: "461703259060",
  appId: "1:461703259060:web:7cc17920890252ea6708e1",
  measurementId: "G-T49HG7DXSC"
        };
        // ============================================================

        var STORAGE_KEY = 'community-captioner-settings';
        var CHANNEL_KEY = 'community-captioner-channel';

        // Check if Firebase is configured
        function isFirebaseConfigured() {
            return FIREBASE_CONFIG.apiKey && 
                   FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY" &&
                   FIREBASE_CONFIG.databaseURL &&
                   FIREBASE_CONFIG.databaseURL.indexOf('firebaseio.com') !== -1;
        }

        // Initialize Firebase
        var firebaseApp = null;
        var database = null;
        if (isFirebaseConfigured()) {
            try {
                firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
                database = firebase.database();
                console.log('Firebase initialized successfully');
            } catch (e) {
                console.error('Firebase initialization failed:', e);
            }
        } else {
            console.log('Firebase not configured - using local mode only');
        }

        // Generate a random channel ID
        function generateChannelId() {
            var chars = 'abcdefghjkmnpqrstuvwxyz23456789'; // Removed confusing chars
            var result = '';
            for (var i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Get or create channel ID
        function getChannelId() {
            var channelId = localStorage.getItem(CHANNEL_KEY);
            if (!channelId) {
                channelId = generateChannelId();
                localStorage.setItem(CHANNEL_KEY, channelId);
            }
            return channelId;
        }

        var defaultSettings = {
            fontSize: 48, fontFamily: 'DM Sans', textColor: '#FFFFFF', backgroundColor: '#000000',
            backgroundOpacity: 75, textAlign: 'center', position: 'bottom', maxLines: 2, maxWidth: 80,
            showBackground: true, textShadow: true, language: 'en-US', paddingH: 32, paddingV: 16
        };

        const isOverlayMode = () => new URLSearchParams(window.location.search).get('overlay') === 'true';

        function CaptionOverlay() {
            const [caption, setCaption] = useState('');
            const [settings, setSettings] = useState(defaultSettings);
            const channelId = new URLSearchParams(window.location.search).get('channel');

            useEffect(() => {
                document.body.classList.add('overlay-mode');

                // If we have a channel ID and Firebase is configured, listen to Firebase
                if (channelId && database) {
                    const channelRef = database.ref(`channels/${channelId}`);
                    channelRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setCaption(data.caption || '');
                            if (data.settings) setSettings(prev => ({ ...prev, ...data.settings }));
                        }
                    });
                    return () => {
                        channelRef.off();
                        document.body.classList.remove('overlay-mode');
                    };
                }

                // Fallback: poll local server
                const poll = setInterval(async () => {
                    try {
                        const res = await fetch('/api/caption');
                        const data = await res.json();
                        setCaption(data.caption || '');
                        if (data.settings) setSettings(prev => ({ ...prev, ...data.settings }));
                    } catch (e) {}
                }, 100);
                return () => { clearInterval(poll); document.body.classList.remove('overlay-mode'); };
            }, [channelId]);

            const getBg = () => {
                if (!settings.showBackground) return 'transparent';
                const hex = settings.backgroundColor;
                const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r},${g},${b},${settings.backgroundOpacity / 100})`;
            };

            const getPos = () => {
                if (settings.position === 'top') return { top: '40px' };
                if (settings.position === 'middle') return { top: '50%', transform: 'translateY(-50%)' };
                return { bottom: '40px' };
            };

            if (!caption) return null;
            return (
                <div className="overlay-container">
                    <div className="caption-display" style={getPos()}>
                        <div className="caption-text-overlay" style={{
                            fontSize: `${settings.fontSize}px`, fontFamily: `${settings.fontFamily}, sans-serif`,
                            color: settings.textColor, backgroundColor: getBg(), textAlign: settings.textAlign,
                            padding: settings.showBackground ? `${settings.paddingV || 16}px ${settings.paddingH || 32}px` : '0',
                            borderRadius: '12px', textShadow: settings.textShadow ? '2px 2px 4px rgba(0,0,0,0.8)' : 'none',
                            maxWidth: `${settings.maxWidth}%`
                        }}>{caption}</div>
                    </div>
                </div>
            );
        }

        function ControlPanel() {
            const [settings, setSettings] = useState(defaultSettings);
            const [isListening, setIsListening] = useState(false);
            const [currentCaption, setCurrentCaption] = useState('');
            const [interimCaption, setInterimCaption] = useState('');
            const [audioDevices, setAudioDevices] = useState([]);
            const [selectedDevice, setSelectedDevice] = useState('');
            const [copiedUrl, setCopiedUrl] = useState(null);
            const [showUrlModal, setShowUrlModal] = useState(false);
            const [selectedUrlOption, setSelectedUrlOption] = useState('firebase');
            const [channelId] = useState(getChannelId);
            const [firebaseConnected, setFirebaseConnected] = useState(false);
            const [localIP, setLocalIP] = useState('');
            const recognitionRef = useRef(null);

            const baseUrl = window.location.origin;
            const localUrl = `http://localhost:8080?overlay=true`;
            const networkUrl = localIP ? `http://${localIP}:8080?overlay=true` : '';
            const firebaseUrl = `${baseUrl}/overlay.html?channel=${channelId}`;

            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) try { setSettings(prev => ({ ...prev, ...JSON.parse(saved) })); } catch (e) {}
                navigator.mediaDevices?.enumerateDevices().then(devices => {
                    const inputs = devices.filter(d => d.kind === 'audioinput');
                    setAudioDevices(inputs);
                    if (inputs.length) setSelectedDevice(inputs[0].deviceId);
                }).catch(() => {});
                
                // Get local IP for network mode
                fetch('/api/info').then(r => r.json()).then(d => { if (d.local_ip) setLocalIP(d.local_ip); }).catch(() => {});

                // Test Firebase connection
                if (database) {
                    database.ref('.info/connected').on('value', (snap) => {
                        setFirebaseConnected(snap.val() === true);
                    });
                }
            }, []);

            // Write to Firebase whenever caption or settings change
            useEffect(() => {
                const text = interimCaption || currentCaption;
                
                // Write to Firebase if configured
                if (database && channelId) {
                    database.ref(`channels/${channelId}`).set({
                        caption: text,
                        settings: settings,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    }).catch(e => console.error('Firebase write error:', e));
                }

                // Also try local server (for same-computer mode)
                fetch('/api/caption', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ caption: text, settings }) 
                }).catch(() => {});
            }, [currentCaption, interimCaption, settings, channelId]);

            // Save settings to localStorage
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            }, [settings]);

            const updateSetting = (k, v) => setSettings(p => ({ ...p, [k]: v }));

            const limitToLines = (text, maxLines) => {
                const charsPerLine = Math.floor((1920 * (settings.maxWidth / 100) - (settings.paddingH || 32) * 2) / (settings.fontSize * 0.5));
                const maxChars = maxLines * charsPerLine;
                if (text.length <= maxChars) return text;
                const trimmed = text.slice(-maxChars);
                const breakPoint = Math.floor(trimmed.length * 0.3);
                const firstSpace = trimmed.indexOf(' ', 0);
                return firstSpace > 0 && firstSpace < breakPoint ? trimmed.slice(firstSpace + 1) : trimmed;
            };

            const startListening = async () => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert('Speech recognition not supported. Please use Chrome or Edge.'); return;
                }
                try { await navigator.mediaDevices.getUserMedia({ audio: selectedDevice ? { deviceId: { exact: selectedDevice } } : true }); } 
                catch { alert('Please allow microphone access.'); return; }
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.continuous = true; recognition.interimResults = true; recognition.lang = settings.language;
                recognition.onresult = (e) => {
                    let interim = '', final = '';
                    for (let i = e.resultIndex; i < e.results.length; i++) {
                        const t = e.results[i][0].transcript;
                        if (e.results[i].isFinal) final += t; else interim += t;
                    }
                    if (final) { setCurrentCaption(p => limitToLines((p + ' ' + final).trim(), settings.maxLines)); setInterimCaption(''); }
                    else setInterimCaption(limitToLines(interim, settings.maxLines));
                };
                recognition.onerror = (e) => { if (e.error === 'not-allowed') alert('Microphone access denied.'); };
                recognition.onend = () => { if (isListening && recognitionRef.current) recognitionRef.current.start(); };
                recognitionRef.current = recognition; recognition.start(); setIsListening(true);
            };

            const stopListening = () => { if (recognitionRef.current) { recognitionRef.current.stop(); recognitionRef.current = null; } setIsListening(false); };
            
            const clearCaptions = () => { 
                setCurrentCaption(''); 
                setInterimCaption(''); 
                // Clear in Firebase too
                if (database && channelId) {
                    database.ref(`channels/${channelId}/caption`).set('');
                }
                fetch('/api/clear', { method: 'POST' }).catch(() => {}); 
            };
            
            const popOut = () => window.open(window.location.href, 'CaptionerControl', 'width=520,height=900,menubar=no,toolbar=no');

            const regenerateChannel = () => {
                const newId = generateChannelId();
                localStorage.setItem(CHANNEL_KEY, newId);
                window.location.reload();
            };

            const getSelectedUrl = () => {
                if (selectedUrlOption === 'local') return localUrl;
                if (selectedUrlOption === 'network') return networkUrl;
                return firebaseUrl;
            };

            const copySelectedUrl = () => {
                const url = getSelectedUrl();
                if (url) {
                    navigator.clipboard.writeText(url);
                    setCopiedUrl('modal');
                    setTimeout(() => { setCopiedUrl(null); setShowUrlModal(false); }, 1200);
                }
            };

            const displayCaption = interimCaption || currentCaption;
            const getBg = () => {
                if (!settings.showBackground) return 'transparent';
                const hex = settings.backgroundColor;
                const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r},${g},${b},${settings.backgroundOpacity / 100})`;
            };

            const firebaseConfigured = isFirebaseConfigured();

            return (
                <div className="app-container">
                    <header className="header">
                        <div className="logo">
                            <div className="logo-mark"><div className="logo-bar logo-bar-1"></div><div className="logo-bar logo-bar-2"></div></div>
                            <div className="logo-text"><span>COMMUNITY</span><span>CAPTIONER <span className="cc-badge">CC</span></span></div>
                        </div>
                        <div className="header-right">
                            <div className="header-actions">
                                {firebaseConfigured ? (
                                    <div className={`channel-badge ${firebaseConnected ? '' : 'warning'}`} title={firebaseConnected ? 'Connected to Firebase' : 'Connecting...'}>
                                        Channel: <code>{channelId}</code>
                                    </div>
                                ) : (
                                    <div className="channel-badge warning" title="Click to set up cloud sync" style={{ cursor: 'pointer' }} onClick={() => setShowUrlModal(true)}>
                                        Cloud: Setup Required
                                    </div>
                                )}
                                <div className="status-pill"><span>{isListening ? 'Listening' : 'Stopped'}</span><div className={`status-dot ${isListening ? '' : 'inactive'}`}></div></div>
                                <button className="popout-btn" onClick={popOut} title="Pop out to keep mic active">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/></svg>
                                    Pop Out
                                </button>
                            </div>
                            <img src="big-logo.png" alt="Brookline Interactive Group" className="big-logo" />
                        </div>
                    </header>

                    <div className="preview-area">
                        <span className="preview-label">Live Preview</span>
                        <div className={`preview-text ${!displayCaption ? 'placeholder' : ''}`} style={displayCaption ? {
                            fontSize: `${Math.min(settings.fontSize * 0.55, 30)}px`, fontFamily: `${settings.fontFamily}, sans-serif`,
                            color: settings.textColor, backgroundColor: getBg(), textAlign: settings.textAlign,
                            padding: settings.showBackground ? `${(settings.paddingV || 16) * 0.6}px ${(settings.paddingH || 32) * 0.6}px` : '0',
                            textShadow: settings.textShadow ? '1px 1px 3px rgba(0,0,0,0.6)' : 'none', maxWidth: `${settings.maxWidth}%`
                        } : {}}>
                            {displayCaption || 'Captions will appear here when you start speaking...'}
                        </div>
                    </div>

                    <div className="steps-container">
                        <div className={`step-btn ${selectedDevice ? 'completed' : 'active'}`} onClick={() => document.getElementById('audioSelect')?.focus()}>
                            <div className="step-num-circle"><span>1</span></div>
                            <div className="step-title">Select Audio</div>
                            <div className="step-desc">Choose your microphone or audio input device</div>
                            <button className="step-action" onClick={(e) => { e.stopPropagation(); document.getElementById('audioSelect')?.focus(); }}>
                                {selectedDevice ? 'Change Device' : 'Select Device'}
                            </button>
                        </div>
                        <div className={`step-btn ${isListening ? 'completed' : (selectedDevice ? 'active' : '')}`}>
                            <div className="step-num-circle"><span>2</span></div>
                            <div className="step-title">Start Captioning</div>
                            <div className="step-desc">Begin speech recognition to generate captions</div>
                            <button className="step-action" onClick={isListening ? stopListening : startListening}>
                                {isListening ? '■ Stop' : '● Start'}
                            </button>
                        </div>
                        <div className={`step-btn ${copiedUrl ? 'completed' : (isListening ? 'active' : '')}`} onClick={() => setShowUrlModal(true)}>
                            <div className="step-num-circle"><span>3</span></div>
                            <div className="step-title">Copy to OBS</div>
                            <div className="step-desc">Choose your setup and copy the overlay URL</div>
                            <button className="step-action" onClick={(e) => { e.stopPropagation(); setShowUrlModal(true); }}>
                                {copiedUrl ? '✓ Copied!' : 'Get URL'}
                            </button>
                        </div>
                    </div>

                    {/* URL Selection Modal */}
                    {showUrlModal && (
                        <div className="modal-overlay" onClick={() => setShowUrlModal(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2 className="modal-title">Where is OBS running?</h2>
                                    <button className="modal-close" onClick={() => setShowUrlModal(false)}>×</button>
                                </div>

                                <div className={`url-option ${selectedUrlOption === 'firebase' ? 'selected' : ''}`} onClick={() => setSelectedUrlOption('firebase')}>
                                        <div className="url-option-header">
                                            <div className="url-option-icon">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                                            </div>
                                            <span className="url-option-title">Anywhere (Cloud)</span>
                                            <span className="url-option-badge">Recommended</span>
                                        </div>
                                        <p className="url-option-desc">Works from any computer, anywhere in the world</p>
                                        {selectedUrlOption === 'firebase' && (
                                            firebaseConfigured ? (
                                                <>
                                                    <div className="url-option-url">{firebaseUrl}</div>
                                                    <p style={{ fontSize: '11px', color: 'var(--green-bright)', marginTop: '6px', paddingLeft: '42px' }}>
                                                        {firebaseConnected ? '● Connected to Firebase' : '○ Connecting...'}
                                                    </p>
                                                </>
                                            ) : (
                                                <div style={{ marginTop: '10px', padding: '12px', background: '#FEF3C7', border: '1px solid #F59E0B', borderRadius: 'var(--radius-sm)', fontSize: '13px', color: '#92400E' }}>
                                                    <strong>Setup required:</strong> Add your Firebase config to enable cloud sync. See <a href="FIREBASE-SETUP.md" target="_blank" style={{ color: '#92400E' }}>FIREBASE-SETUP.md</a> for instructions.
                                                </div>
                                            )
                                        )}
                                    </div>

                                <div className={`url-option ${selectedUrlOption === 'local' ? 'selected' : ''}`} onClick={() => setSelectedUrlOption('local')}>
                                    <div className="url-option-header">
                                        <div className="url-option-icon">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
                                        </div>
                                        <span className="url-option-title">Same Computer</span>
                                    </div>
                                    <p className="url-option-desc">OBS is running on this machine (requires desktop app)</p>
                                    {selectedUrlOption === 'local' && <div className="url-option-url">{localUrl}</div>}
                                </div>

                                <div className={`url-option ${selectedUrlOption === 'network' ? 'selected' : ''}`} onClick={() => setSelectedUrlOption('network')}>
                                    <div className="url-option-header">
                                        <div className="url-option-icon">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12.55a11 11 0 0 1 14.08 0M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><circle cx="12" cy="20" r="1"/></svg>
                                        </div>
                                        <span className="url-option-title">Local Network</span>
                                    </div>
                                    <p className="url-option-desc">OBS on another computer on your WiFi/LAN (requires desktop app)</p>
                                    {selectedUrlOption === 'network' && <div className="url-option-url">{networkUrl || 'Run desktop app to detect IP'}</div>}
                                </div>

                                <button className={`modal-copy-btn ${copiedUrl === 'modal' ? 'copied' : ''}`} onClick={copySelectedUrl} disabled={(selectedUrlOption === 'network' && !networkUrl) || (selectedUrlOption === 'firebase' && !firebaseConfigured)}>
                                    {copiedUrl === 'modal' ? '✓ Copied to Clipboard!' : 'Copy URL to Clipboard'}
                                </button>
                                <p className="modal-note">In OBS: Add Browser Source → paste URL → set size to <strong>1920 × 1080</strong></p>
                                
                                {firebaseConfigured && channelId && (
                                    <p className="modal-note" style={{ marginTop: '16px', paddingTop: '12px', borderTop: '1px solid var(--border-light)' }}>
                                        Your channel: <strong>{channelId}</strong> · <button onClick={regenerateChannel} style={{ background: 'none', border: 'none', color: 'var(--green-primary)', cursor: 'pointer', textDecoration: 'underline' }}>Get new channel</button>
                                    </p>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="cards-container">
                        <div className="card">
                            <h3 className="card-title">Caption Style</h3>
                            <div className="form-row"><span className="form-label">Text Size</span><div className="slider-container"><input type="range" className="slider" min="24" max="72" value={settings.fontSize} onChange={e => updateSetting('fontSize', +e.target.value)} /><span className="slider-value">{settings.fontSize}</span></div></div>
                            <div className="form-row"><span className="form-label">Text Color</span><input type="color" className="color-picker" value={settings.textColor} onChange={e => updateSetting('textColor', e.target.value)} /></div>
                            <div className="form-row"><span className="form-label">Background</span>
                                <div style={{ display: 'flex', gap: '6px', alignItems: 'center' }}>
                                    <div className="btn-group">
                                        <button className={`btn-group-item ${!settings.showBackground ? 'active' : ''}`} onClick={() => updateSetting('showBackground', false)} title="None"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                                        <button className={`btn-group-item ${settings.showBackground ? 'active' : ''}`} onClick={() => updateSetting('showBackground', true)} title="Show"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></button>
                                    </div>
                                    {settings.showBackground && <input type="color" className="color-picker" value={settings.backgroundColor} onChange={e => updateSetting('backgroundColor', e.target.value)} style={{ width: '28px', height: '28px' }} />}
                                </div>
                            </div>
                            <div className="form-row"><span className="form-label">Alignment</span>
                                <div className="btn-group">
                                    {['left', 'center', 'right'].map(a => (
                                        <button key={a} className={`btn-group-item ${settings.textAlign === a ? 'active' : ''}`} onClick={() => updateSetting('textAlign', a)}>
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                {a === 'left' && <><line x1="3" y1="6" x2="15" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="15" y2="18"/></>}
                                                {a === 'center' && <><line x1="6" y1="6" x2="18" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="18" y2="18"/></>}
                                                {a === 'right' && <><line x1="9" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="9" y1="18" x2="21" y2="18"/></>}
                                            </svg>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="form-row"><span className="form-label">Position</span>
                                <div className="btn-group">
                                    {['top', 'middle', 'bottom'].map(p => (
                                        <button key={p} className={`btn-group-item ${settings.position === p ? 'active' : ''}`} onClick={() => updateSetting('position', p)} style={{ width: '44px', fontSize: '10px' }}>{p.charAt(0).toUpperCase() + p.slice(1)}</button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="card">
                            <h3 className="card-title">Audio Input</h3>
                            <select id="audioSelect" className="audio-select" value={selectedDevice} onChange={e => setSelectedDevice(e.target.value)}>
                                {audioDevices.length === 0 && <option>No devices found</option>}
                                {audioDevices.map(d => <option key={d.deviceId} value={d.deviceId}>{d.label || `Mic ${d.deviceId.slice(0, 8)}`}</option>)}
                            </select>
                            <button className={`action-btn ${isListening ? 'stop' : 'start'}`} onClick={isListening ? stopListening : startListening}>{isListening ? '■ Stop' : '● Start Captioning'}</button>
                            <button className="clear-btn" onClick={clearCaptions}>Clear Captions</button>
                            <p className="audio-info">For external audio (mixers, capture cards), route audio to your computer and select above.</p>
                        </div>

                        {/* Size & Layout - Always expanded */}
                        <div className="card full-width">
                            <h3 className="card-title">Size & Layout</h3>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <div className="form-row"><span className="form-label">Max Width</span><div className="slider-container"><input type="range" className="slider" min="40" max="100" step="5" value={settings.maxWidth} onChange={e => updateSetting('maxWidth', +e.target.value)} /><span className="slider-value">{settings.maxWidth}%</span></div></div>
                                    <div className="form-row"><span className="form-label">Max Lines</span><div className="slider-container"><input type="range" className="slider" min="1" max="4" value={settings.maxLines} onChange={e => updateSetting('maxLines', +e.target.value)} /><span className="slider-value">{settings.maxLines}</span></div></div>
                                </div>
                                <div>
                                    <div className="form-row"><span className="form-label">H Padding</span><div className="slider-container"><input type="range" className="slider" min="8" max="64" value={settings.paddingH || 32} onChange={e => updateSetting('paddingH', +e.target.value)} /><span className="slider-value">{settings.paddingH || 32}</span></div></div>
                                    <div className="form-row"><span className="form-label">V Padding</span><div className="slider-container"><input type="range" className="slider" min="4" max="48" value={settings.paddingV || 16} onChange={e => updateSetting('paddingV', +e.target.value)} /><span className="slider-value">{settings.paddingV || 16}</span></div></div>
                                </div>
                            </div>
                            <div style={{ marginTop: '10px' }}>
                                <div className="form-row"><span className="form-label">BG Opacity</span><div className="slider-container"><input type="range" className="slider" min="0" max="100" value={settings.backgroundOpacity} onChange={e => updateSetting('backgroundOpacity', +e.target.value)} style={{ width: '100px' }} /><span className="slider-value">{settings.backgroundOpacity}%</span></div></div>
                                <div className="form-row"><span className="form-label">Text Shadow</span><div className="btn-group"><button className={`btn-group-item ${settings.textShadow ? 'active' : ''}`} onClick={() => updateSetting('textShadow', true)} style={{ width: '40px', fontSize: '10px' }}>On</button><button className={`btn-group-item ${!settings.textShadow ? 'active' : ''}`} onClick={() => updateSetting('textShadow', false)} style={{ width: '40px', fontSize: '10px' }}>Off</button></div></div>
                            </div>
                        </div>
                    </div>

                    {/* FAQ Section */}
                    <div className="faq-section">
                        <h2 className="faq-title">Frequently Asked Questions</h2>
                        <div className="faq-grid">
                            <div className="faq-item">
                                <div className="faq-question">What is a Browser Source in OBS?</div>
                                <div className="faq-answer">A Browser Source lets OBS display a webpage as a layer in your video. Add one via Sources → + → Browser, paste the overlay URL, and set dimensions to 1920×1080. The transparent background lets captions appear over your video.</div>
                            </div>
                            <div className="faq-item">
                                <div className="faq-question">How do I use this with a Downstream Keyer?</div>
                                <div className="faq-answer">If your video switcher (like ATEM) has a DSK, you can route a computer running the overlay through it. Set the overlay as a fill source, or use OBS to output via NDI/SDI to your switcher's DSK input for professional caption keying.</div>
                            </div>
                            <div className="faq-item">
                                <div className="faq-question">How reliable is the speech recognition?</div>
                                <div className="faq-answer">This uses your browser's built-in Web Speech API (Chrome/Edge), which connects to Google's servers. It's generally very accurate for clear speech. For best results: use a good microphone, speak clearly, minimize background noise, and ensure stable internet.</div>
                            </div>
                            <div className="faq-item">
                                <div className="faq-question">How can I optimize caption quality?</div>
                                <div className="faq-answer">Use a dedicated microphone close to the speaker. Choose a quiet environment. Set Max Lines to 2-3 for readability. Enable Text Shadow for better visibility over video. Test your setup before going live.</div>
                            </div>
                            <div className="faq-item">
                                <div className="faq-question">Why do captions stop when I switch tabs?</div>
                                <div className="faq-answer">Browsers pause inactive tabs to save resources. Use the "Pop Out" button to open the control panel in a separate window that stays active. Alternatively, download the desktop app which runs independently.</div>
                            </div>
                            <div className="faq-item">
                                <div className="faq-question">Can multiple people use this simultaneously?</div>
                                <div className="faq-answer">Yes! Each user gets their own unique channel ID. Share your channel URL with others who need to see the overlay. With Firebase enabled, each channel syncs independently in real-time.</div>
                            </div>
                            <div className="faq-item">
                                <div className="faq-question">What browsers are supported?</div>
                                <div className="faq-answer">Chrome and Edge work best as they fully support the Web Speech API. Firefox and Safari have limited or no speech recognition support. OBS's browser source is Chromium-based, so overlays work perfectly.</div>
                            </div>
                            <div className="faq-item">
                                <div className="faq-question">Can I use captions from a capture card?</div>
                                <div className="faq-answer">Yes! If your capture card (Elgato, Blackmagic, etc.) outputs audio to your computer, select it as the input device. You may need to route audio through virtual audio software like VB-Cable or Loopback for some setups.</div>
                            </div>
                        </div>
                    </div>

                    <footer className="footer">
                        <p>A community AI project from <a href="https://brooklineinteractive.org" target="_blank" rel="noopener noreferrer">Brookline Interactive Group</a><br/>Designed and developed by <a href="https://weirdmachine.org" target="_blank" rel="noopener noreferrer">Stephen Walter</a></p>
                        <div className="footer-links">
                            <a href="https://github.com/amateurmenace/community-captioner" target="_blank" rel="noopener noreferrer" className="footer-link">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                                GitHub
                            </a>
                            <span className="footer-link">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M14.31 8l5.74 9.94M9.69 8h11.48M7.38 12l5.74-9.94M9.69 16L3.95 6.06M14.31 16H2.83M16.62 12l-5.74 9.94"/></svg>
                                CC BY-SA 4.0
                            </span>
                        </div>
                        <p style={{marginTop: '20px', fontSize: '14px', color: 'var(--text-light)'}}>
                            Having trouble with the cloud app? <a href="https://github.com/amateurmenace/community-captioner/releases" target="_blank" rel="noopener noreferrer">Download the desktop app instead</a>
                        </p>
                    </footer>
                </div>
            );
        }

        function App() { return isOverlayMode() ? <CaptionOverlay /> : <ControlPanel />; }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
