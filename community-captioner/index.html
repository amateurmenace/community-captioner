<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Captioner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --bg-cream: #F5F3EE;
            --bg-white: #FFFFFF;
            --bg-preview: #1a1a2e;
            --green-primary: #3D5A47;
            --green-light: #4A6B52;
            --green-bright: #00A676;
            --green-bar-1: #3D5A47;
            --green-bar-2: #6B9B76;
            --text-dark: #3D5A47;
            --text-medium: #5A6B5E;
            --text-light: #8A9A8E;
            --border-light: #D4D2CD;
            --border-card: #E0DED9;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-cream);
            color: var(--text-dark);
            line-height: 1.5;
            min-height: 100vh;
        }

        body.overlay-mode { background: transparent; overflow: hidden; }

        .app-container { max-width: 920px; margin: 0 auto; padding: 20px; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 12px 0; }
        .logo { display: flex; align-items: center; gap: 16px; }
        .logo-mark { display: flex; flex-direction: column; gap: 5px; }
        .logo-bar { height: 8px; border-radius: 4px; width: 56px; }
        .logo-bar-1 { background: var(--green-bar-1); }
        .logo-bar-2 { background: var(--green-bar-2); }
        .logo-text { font-weight: 700; font-size: 24px; color: var(--text-dark); line-height: 1.1; }
        .logo-text span { display: block; }
        .cc-badge { display: inline-flex; align-items: center; border: 2px solid var(--text-dark); border-radius: 5px; padding: 3px 8px; font-size: 14px; font-weight: 700; margin-left: 8px; }

        .header-right { display: flex; align-items: center; gap: 20px; }
        .big-logo { height: 60px; width: auto; }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .status-pill { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 500; color: var(--text-medium); }
        .status-dot { width: 28px; height: 16px; background: var(--green-primary); border-radius: 8px; position: relative; }
        .status-dot::after { content: ''; position: absolute; right: 2px; top: 2px; width: 12px; height: 12px; background: white; border-radius: 50%; }
        .status-dot.inactive { background: var(--border-light); }
        .status-dot.inactive::after { right: auto; left: 2px; }

        .popout-btn { display: flex; align-items: center; gap: 5px; padding: 6px 12px; background: var(--bg-white); border: 1px solid var(--border-card); border-radius: var(--radius-sm); font-family: inherit; font-size: 12px; font-weight: 500; color: var(--text-medium); cursor: pointer; }
        .popout-btn:hover { border-color: var(--green-primary); color: var(--green-primary); }

        /* Interactive Steps */
        .steps-container { display: flex; gap: 16px; margin-bottom: 20px; }
        .step-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 20px 16px; background: var(--bg-white); border: 2px solid var(--border-card); border-radius: var(--radius-lg); cursor: pointer; transition: all 0.2s; text-align: center; }
        .step-btn:hover { border-color: var(--green-primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .step-btn.completed { border-color: var(--green-bright); background: #F0F9F4; }
        .step-btn.active { border-color: var(--green-primary); box-shadow: 0 0 0 3px rgba(61, 90, 71, 0.15); }
        .step-num-circle { width: 36px; height: 36px; background: var(--green-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; }
        .step-btn.completed .step-num-circle { background: var(--green-bright); }
        .step-btn.completed .step-num-circle::after { content: '✓'; }
        .step-btn.completed .step-num-circle span { display: none; }
        .step-title { font-weight: 600; font-size: 15px; color: var(--text-dark); }
        .step-desc { font-size: 12px; color: var(--text-light); line-height: 1.4; }
        .step-action { margin-top: 6px; padding: 8px 16px; background: var(--green-primary); color: white; border: none; border-radius: var(--radius-sm); font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .step-action:hover { background: var(--green-light); }
        .step-btn.completed .step-action { background: var(--green-bright); }

        /* Preview */
        .preview-area { background: #E8E6E1; border-radius: var(--radius-lg); padding: 40px 24px; margin-bottom: 20px; min-height: 160px; display: flex; align-items: center; justify-content: center; position: relative; border: 1px solid var(--border-card); }
        .preview-label { position: absolute; top: 10px; left: 14px; font-size: 10px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        .preview-text { font-size: 24px; font-weight: 500; color: #333; text-align: center; line-height: 1.3; padding: 12px 24px; border-radius: 8px; max-width: 90%; }
        .preview-text.placeholder { color: var(--text-light); font-size: 18px; background: transparent !important; }

        /* Cards */
        .cards-container { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
        .card { background: var(--bg-white); border: 1px solid var(--border-card); border-radius: var(--radius-lg); padding: 18px; }
        .card.full-width { grid-column: 1 / -1; }
        .card-title { font-size: 15px; font-weight: 600; color: var(--text-dark); margin-bottom: 14px; }

        /* Form */
        .form-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .form-row:last-child { margin-bottom: 0; }
        .form-label { font-size: 13px; color: var(--text-medium); }
        .slider-container { display: flex; align-items: center; gap: 8px; }
        .slider { width: 90px; height: 4px; -webkit-appearance: none; background: var(--border-light); border-radius: 2px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--text-dark); border-radius: 50%; cursor: pointer; }
        .slider-value { min-width: 38px; padding: 5px 8px; background: var(--bg-cream); border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-size: 12px; font-weight: 500; text-align: center; }
        .color-picker { width: 32px; height: 32px; border: none; border-radius: var(--radius-sm); cursor: pointer; padding: 0; }
        .color-picker::-webkit-color-swatch-wrapper { padding: 0; }
        .color-picker::-webkit-color-swatch { border: 2px solid var(--border-light); border-radius: var(--radius-sm); }

        .btn-group { display: flex; gap: 2px; background: var(--bg-cream); padding: 2px; border-radius: var(--radius-sm); }
        .btn-group-item { width: 30px; height: 26px; border: none; background: transparent; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-medium); font-size: 12px; transition: all 0.15s; }
        .btn-group-item:hover { background: var(--bg-white); }
        .btn-group-item.active { background: var(--green-primary); color: white; }

        /* Audio */
        .audio-select { width: 100%; padding: 9px 12px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-family: inherit; font-size: 12px; color: var(--text-dark); background: var(--bg-cream); cursor: pointer; margin-bottom: 12px; }
        .action-btn { width: 100%; padding: 11px 18px; border: none; border-radius: var(--radius-md); font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; }
        .action-btn.start { background: var(--green-primary); color: white; }
        .action-btn.start:hover { background: var(--green-light); }
        .action-btn.stop { background: #DC3545; color: white; }
        .clear-btn { width: 100%; padding: 8px; margin-top: 8px; border: 1px solid var(--border-light); background: transparent; border-radius: var(--radius-sm); font-family: inherit; font-size: 12px; color: var(--text-medium); cursor: pointer; }
        .audio-info { color: var(--text-light); font-size: 11px; margin-top: 10px; line-height: 1.4; }

        /* Collapsible */
        .section-toggle { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .section-toggle .card-title { margin-bottom: 0; }
        .toggle-icon { color: var(--text-light); transition: transform 0.2s; }
        .toggle-icon.open { transform: rotate(180deg); }
        .section-content { display: none; padding-top: 14px; }
        .section-content.open { display: block; }

        /* OBS */
        .obs-option { background: var(--bg-cream); border-radius: var(--radius-md); padding: 12px; margin-bottom: 8px; }
        .obs-option:last-child { margin-bottom: 0; }
        .obs-option-header { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
        .obs-option-number { width: 18px; height: 18px; background: var(--green-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; }
        .obs-option-title { font-weight: 600; font-size: 13px; }
        .obs-option-desc { font-size: 11px; color: var(--text-light); margin-bottom: 6px; padding-left: 24px; }
        .url-row { display: flex; gap: 5px; padding-left: 24px; }
        .url-input { flex: 1; padding: 7px 10px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-family: monospace; font-size: 11px; color: var(--text-dark); background: var(--bg-white); }
        .copy-btn { background: var(--green-primary); color: white; border: none; border-radius: var(--radius-sm); padding: 7px 12px; font-family: inherit; font-size: 11px; font-weight: 600; cursor: pointer; }
        .copy-btn:hover { background: var(--green-light); }
        .copy-btn.copied { background: var(--green-bright); }
        .obs-settings-row { display: flex; gap: 10px; padding-left: 24px; margin-top: 6px; font-size: 11px; color: var(--text-medium); }
        .obs-settings-row strong { color: var(--green-primary); }
        .cloud-input-row { display: flex; gap: 5px; padding-left: 24px; margin-bottom: 5px; }
        .cloud-input { flex: 1; padding: 7px 10px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-family: inherit; font-size: 11px; background: var(--bg-white); }
        .cloud-input::placeholder { color: var(--text-light); }

        /* Footer */
        .footer { text-align: center; padding: 20px 16px; color: var(--text-light); font-size: 12px; line-height: 1.6; border-top: 1px solid var(--border-light); margin-top: 16px; }
        .footer a { color: var(--green-primary); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        .footer-links { margin-top: 6px; display: flex; justify-content: center; gap: 14px; flex-wrap: wrap; }
        .footer-link { display: flex; align-items: center; gap: 4px; }

        @media (max-width: 700px) {
            .cards-container { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 12px; align-items: flex-start; }
            .header-right { width: 100%; justify-content: space-between; }
            .steps-container { flex-direction: column; }
            .step-btn { flex-direction: row; padding: 16px; gap: 14px; text-align: left; }
            .step-btn .step-desc { display: none; }
            .slider { width: 60px; }
            .big-logo { height: 44px; }
        }

        .overlay-container { width: 1920px; height: 1080px; position: relative; }
        .caption-display { position: absolute; width: 100%; padding: 20px 60px; display: flex; justify-content: center; z-index: 10000; }
        .caption-text-overlay { word-wrap: break-word; line-height: 1.4; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const STORAGE_KEY = 'community-captioner-settings';
        const REMOTE_SERVER_KEY = 'community-captioner-remote-server';
        const DEFAULT_CLOUD_SERVER = 'http://138.197.15.64:8080';

        const defaultSettings = {
            fontSize: 48, fontFamily: 'DM Sans', textColor: '#FFFFFF', backgroundColor: '#000000',
            backgroundOpacity: 75, textAlign: 'center', position: 'bottom', maxLines: 2, maxWidth: 80,
            showBackground: true, textShadow: true, language: 'en-US', paddingH: 32, paddingV: 16
        };

        const isOverlayMode = () => new URLSearchParams(window.location.search).get('overlay') === 'true';

        function CaptionOverlay() {
            const [caption, setCaption] = useState('');
            const [settings, setSettings] = useState(defaultSettings);

            useEffect(() => {
                document.body.classList.add('overlay-mode');
                const poll = setInterval(async () => {
                    try {
                        const res = await fetch('/api/caption');
                        const data = await res.json();
                        setCaption(data.caption || '');
                        if (data.settings) setSettings(prev => ({ ...prev, ...data.settings }));
                    } catch (e) {}
                }, 100);
                return () => { clearInterval(poll); document.body.classList.remove('overlay-mode'); };
            }, []);

            const getBg = () => {
                if (!settings.showBackground) return 'transparent';
                const hex = settings.backgroundColor;
                const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r},${g},${b},${settings.backgroundOpacity / 100})`;
            };

            const getPos = () => {
                if (settings.position === 'top') return { top: '40px' };
                if (settings.position === 'middle') return { top: '50%', transform: 'translateY(-50%)' };
                return { bottom: '40px' };
            };

            if (!caption) return null;
            return (
                <div className="overlay-container">
                    <div className="caption-display" style={getPos()}>
                        <div className="caption-text-overlay" style={{
                            fontSize: `${settings.fontSize}px`, fontFamily: `${settings.fontFamily}, sans-serif`,
                            color: settings.textColor, backgroundColor: getBg(), textAlign: settings.textAlign,
                            padding: settings.showBackground ? `${settings.paddingV || 16}px ${settings.paddingH || 32}px` : '0',
                            borderRadius: '12px', textShadow: settings.textShadow ? '2px 2px 4px rgba(0,0,0,0.8)' : 'none',
                            maxWidth: `${settings.maxWidth}%`
                        }}>{caption}</div>
                    </div>
                </div>
            );
        }

        function ControlPanel() {
            const [settings, setSettings] = useState(defaultSettings);
            const [isListening, setIsListening] = useState(false);
            const [currentCaption, setCurrentCaption] = useState('');
            const [interimCaption, setInterimCaption] = useState('');
            const [audioDevices, setAudioDevices] = useState([]);
            const [selectedDevice, setSelectedDevice] = useState('');
            const [copiedUrl, setCopiedUrl] = useState(null);
            const [remoteServer, setRemoteServer] = useState(() => localStorage.getItem(REMOTE_SERVER_KEY) || DEFAULT_CLOUD_SERVER);
            const [cloudConnected, setCloudConnected] = useState(false);
            const [localIP, setLocalIP] = useState('');
            const [showAdvanced, setShowAdvanced] = useState(false);
            const recognitionRef = useRef(null);

            const localUrl = `http://localhost:8080?overlay=true`;
            const networkUrl = localIP ? `http://${localIP}:8080?overlay=true` : '';
            const cloudUrl = remoteServer ? `${remoteServer}/overlay.html` : '';

            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) try { setSettings(prev => ({ ...prev, ...JSON.parse(saved) })); } catch (e) {}
                navigator.mediaDevices?.enumerateDevices().then(devices => {
                    const inputs = devices.filter(d => d.kind === 'audioinput');
                    setAudioDevices(inputs);
                    if (inputs.length) setSelectedDevice(inputs[0].deviceId);
                }).catch(() => {});
                fetch('/api/info').then(r => r.json()).then(d => { if (d.local_ip) setLocalIP(d.local_ip); })
                    .catch(() => { const h = window.location.hostname; if (h !== 'localhost' && h !== '127.0.0.1') setLocalIP(h); });
            }, []);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
                fetch('/api/caption', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ settings }) }).catch(() => {});
                if (remoteServer) fetch(`${remoteServer}/api/caption`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ settings }) }).catch(() => {});
            }, [settings, remoteServer]);

            useEffect(() => {
                const text = interimCaption || currentCaption;
                fetch('/api/caption', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ caption: text }) }).catch(() => {});
                if (remoteServer) {
                    fetch(`${remoteServer}/api/caption`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ caption: text, settings }) 
                    })
                    .then(res => { setCloudConnected(res.ok); })
                    .catch(() => { setCloudConnected(false); });
                }
            }, [currentCaption, interimCaption, remoteServer, settings]);

            useEffect(() => { localStorage.setItem(REMOTE_SERVER_KEY, remoteServer); }, [remoteServer]);

            // Test cloud connection periodically
            useEffect(() => {
                if (!remoteServer) { setCloudConnected(false); return; }
                const testConnection = () => {
                    fetch(`${remoteServer}/api/caption`, { method: 'GET' })
                        .then(res => setCloudConnected(res.ok))
                        .catch(() => setCloudConnected(false));
                };
                testConnection();
                const interval = setInterval(testConnection, 5000);
                return () => clearInterval(interval);
            }, [remoteServer]);

            const updateSetting = (k, v) => setSettings(p => ({ ...p, [k]: v }));

            const limitToLines = (text, maxLines, maxWidth) => {
                const charsPerLine = Math.floor(50 * (maxWidth || 80) / 80);
                const maxChars = charsPerLine * maxLines;
                if (text.length <= maxChars) return text;
                let trimmed = text.slice(-maxChars);
                const sp = trimmed.indexOf(' ');
                return sp > 0 && sp < 20 ? trimmed.slice(sp + 1) : trimmed;
            };

            const startListening = async () => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { alert('Use Chrome or Edge for speech recognition.'); return; }
                try { await navigator.mediaDevices.getUserMedia({ audio: selectedDevice ? { deviceId: { exact: selectedDevice } } : true }); } catch { alert('Allow microphone access.'); return; }
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recog = new SR();
                recog.continuous = true; recog.interimResults = true; recog.lang = settings.language;
                recog.onresult = (e) => {
                    let interim = '', final = '';
                    for (let i = e.resultIndex; i < e.results.length; i++) {
                        const t = e.results[i][0].transcript;
                        if (e.results[i].isFinal) final += t; else interim += t;
                    }
                    if (final) { setCurrentCaption(p => limitToLines((p + ' ' + final).trim(), settings.maxLines, settings.maxWidth)); setInterimCaption(''); }
                    else setInterimCaption(limitToLines(interim, settings.maxLines, settings.maxWidth));
                };
                recog.onerror = (e) => { if (e.error === 'not-allowed') alert('Microphone denied.'); };
                recog.onend = () => { if (isListening && recognitionRef.current) try { recog.start(); } catch {} };
                recognitionRef.current = recog; recog.start(); setIsListening(true);
            };

            const stopListening = () => { recognitionRef.current?.stop(); recognitionRef.current = null; setIsListening(false); };
            const clearCaptions = () => { setCurrentCaption(''); setInterimCaption(''); fetch('/api/clear', { method: 'POST' }).catch(() => {}); };
            const copyUrl = (url, id) => { navigator.clipboard.writeText(url); setCopiedUrl(id); setTimeout(() => setCopiedUrl(null), 2000); };
            const popOut = () => window.open(window.location.href, 'CaptionerControl', 'width=520,height=750,menubar=no,toolbar=no');

            const displayCaption = interimCaption || currentCaption;
            const getBg = () => {
                if (!settings.showBackground) return 'transparent';
                const hex = settings.backgroundColor;
                const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r},${g},${b},${settings.backgroundOpacity / 100})`;
            };

            return (
                <div className="app-container">
                    <header className="header">
                        <div className="logo">
                            <div className="logo-mark"><div className="logo-bar logo-bar-1"></div><div className="logo-bar logo-bar-2"></div></div>
                            <div className="logo-text"><span>COMMUNITY</span><span>CAPTIONER <span className="cc-badge">CC</span></span></div>
                        </div>
                        <div className="header-right">
                            <div className="header-actions">
                                <div className="status-pill"><span>{isListening ? 'Listening' : 'Stopped'}</span><div className={`status-dot ${isListening ? '' : 'inactive'}`}></div></div>
                                <button className="popout-btn" onClick={popOut} title="Pop out to keep mic active">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/></svg>
                                    Pop Out
                                </button>
                            </div>
                            <img src="big-logo.png" alt="Brookline Interactive Group" className="big-logo" />
                        </div>
                    </header>

                    <div className="preview-area">
                        <span className="preview-label">Live Preview</span>
                        <div className={`preview-text ${!displayCaption ? 'placeholder' : ''}`} style={displayCaption ? {
                            fontSize: `${Math.min(settings.fontSize * 0.55, 30)}px`, fontFamily: `${settings.fontFamily}, sans-serif`,
                            color: settings.textColor, backgroundColor: getBg(), textAlign: settings.textAlign,
                            padding: settings.showBackground ? `${(settings.paddingV || 16) * 0.6}px ${(settings.paddingH || 32) * 0.6}px` : '0',
                            textShadow: settings.textShadow ? '1px 1px 3px rgba(0,0,0,0.6)' : 'none', maxWidth: `${settings.maxWidth}%`
                        } : {}}>
                            {displayCaption || 'Captions will appear here when you start speaking...'}
                        </div>
                    </div>

                    <div className="steps-container">
                        <div className={`step-btn ${selectedDevice ? 'completed' : 'active'}`} onClick={() => document.getElementById('audioSelect')?.focus()}>
                            <div className="step-num-circle"><span>1</span></div>
                            <div className="step-title">Select Audio</div>
                            <div className="step-desc">Choose your microphone or audio input device</div>
                            <button className="step-action" onClick={(e) => { e.stopPropagation(); document.getElementById('audioSelect')?.focus(); }}>
                                {selectedDevice ? 'Change Device' : 'Select Device'}
                            </button>
                        </div>
                        <div className={`step-btn ${isListening ? 'completed' : (selectedDevice ? 'active' : '')}`}>
                            <div className="step-num-circle"><span>2</span></div>
                            <div className="step-title">Start Captioning</div>
                            <div className="step-desc">Begin speech recognition to generate captions</div>
                            <button className="step-action" onClick={isListening ? stopListening : startListening}>
                                {isListening ? '■ Stop' : '● Start'}
                            </button>
                        </div>
                        <div className={`step-btn ${copiedUrl ? 'completed' : (isListening ? 'active' : '')}`}>
                            <div className="step-num-circle"><span>3</span></div>
                            <div className="step-title">Copy to OBS</div>
                            <div className="step-desc">Add the overlay URL to OBS as a browser source</div>
                            <button className="step-action" onClick={() => copyUrl(cloudUrl || localUrl, 'step')}>
                                {copiedUrl === 'step' ? '✓ Copied!' : 'Copy URL'}
                            </button>
                        </div>
                    </div>

                    <div className="cards-container">
                        <div className="card">
                            <h3 className="card-title">Caption Style</h3>
                            <div className="form-row"><span className="form-label">Text Size</span><div className="slider-container"><input type="range" className="slider" min="24" max="72" value={settings.fontSize} onChange={e => updateSetting('fontSize', +e.target.value)} /><span className="slider-value">{settings.fontSize}</span></div></div>
                            <div className="form-row"><span className="form-label">Text Color</span><input type="color" className="color-picker" value={settings.textColor} onChange={e => updateSetting('textColor', e.target.value)} /></div>
                            <div className="form-row"><span className="form-label">Background</span>
                                <div style={{ display: 'flex', gap: '6px', alignItems: 'center' }}>
                                    <div className="btn-group">
                                        <button className={`btn-group-item ${!settings.showBackground ? 'active' : ''}`} onClick={() => updateSetting('showBackground', false)} title="None"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                                        <button className={`btn-group-item ${settings.showBackground ? 'active' : ''}`} onClick={() => updateSetting('showBackground', true)} title="Show"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></button>
                                    </div>
                                    {settings.showBackground && <input type="color" className="color-picker" value={settings.backgroundColor} onChange={e => updateSetting('backgroundColor', e.target.value)} style={{ width: '28px', height: '28px' }} />}
                                </div>
                            </div>
                            <div className="form-row"><span className="form-label">Alignment</span>
                                <div className="btn-group">
                                    {['left', 'center', 'right'].map(a => (
                                        <button key={a} className={`btn-group-item ${settings.textAlign === a ? 'active' : ''}`} onClick={() => updateSetting('textAlign', a)}>
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                {a === 'left' && <><line x1="3" y1="6" x2="15" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="15" y2="18"/></>}
                                                {a === 'center' && <><line x1="6" y1="6" x2="18" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="18" y2="18"/></>}
                                                {a === 'right' && <><line x1="9" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="9" y1="18" x2="21" y2="18"/></>}
                                            </svg>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="form-row"><span className="form-label">Position</span>
                                <div className="btn-group">
                                    {['top', 'middle', 'bottom'].map(p => (
                                        <button key={p} className={`btn-group-item ${settings.position === p ? 'active' : ''}`} onClick={() => updateSetting('position', p)} style={{ width: '44px', fontSize: '10px' }}>{p.charAt(0).toUpperCase() + p.slice(1)}</button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="card">
                            <h3 className="card-title">Audio Input</h3>
                            <select id="audioSelect" className="audio-select" value={selectedDevice} onChange={e => setSelectedDevice(e.target.value)}>
                                {audioDevices.length === 0 && <option>No devices found</option>}
                                {audioDevices.map(d => <option key={d.deviceId} value={d.deviceId}>{d.label || `Mic ${d.deviceId.slice(0, 8)}`}</option>)}
                            </select>
                            <button className={`action-btn ${isListening ? 'stop' : 'start'}`} onClick={isListening ? stopListening : startListening}>{isListening ? '■ Stop' : '● Start Captioning'}</button>
                            <button className="clear-btn" onClick={clearCaptions}>Clear Captions</button>
                            <p className="audio-info">For external audio (mixers, capture cards), route audio to your computer and select above.</p>
                        </div>

                        <div className="card full-width">
                            <div className="section-toggle" onClick={() => setShowAdvanced(!showAdvanced)}>
                                <h3 className="card-title">Size & Layout</h3>
                                <span className={`toggle-icon ${showAdvanced ? 'open' : ''}`}><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg></span>
                            </div>
                            <div className={`section-content ${showAdvanced ? 'open' : ''}`}>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <div className="form-row"><span className="form-label">Max Width</span><div className="slider-container"><input type="range" className="slider" min="40" max="100" step="5" value={settings.maxWidth} onChange={e => updateSetting('maxWidth', +e.target.value)} /><span className="slider-value">{settings.maxWidth}%</span></div></div>
                                        <div className="form-row"><span className="form-label">Max Lines</span><div className="slider-container"><input type="range" className="slider" min="1" max="4" value={settings.maxLines} onChange={e => updateSetting('maxLines', +e.target.value)} /><span className="slider-value">{settings.maxLines}</span></div></div>
                                    </div>
                                    <div>
                                        <div className="form-row"><span className="form-label">H Padding</span><div className="slider-container"><input type="range" className="slider" min="8" max="64" value={settings.paddingH || 32} onChange={e => updateSetting('paddingH', +e.target.value)} /><span className="slider-value">{settings.paddingH || 32}</span></div></div>
                                        <div className="form-row"><span className="form-label">V Padding</span><div className="slider-container"><input type="range" className="slider" min="4" max="48" value={settings.paddingV || 16} onChange={e => updateSetting('paddingV', +e.target.value)} /><span className="slider-value">{settings.paddingV || 16}</span></div></div>
                                    </div>
                                </div>
                                <div style={{ marginTop: '10px' }}>
                                    <div className="form-row"><span className="form-label">BG Opacity</span><div className="slider-container"><input type="range" className="slider" min="0" max="100" value={settings.backgroundOpacity} onChange={e => updateSetting('backgroundOpacity', +e.target.value)} style={{ width: '100px' }} /><span className="slider-value">{settings.backgroundOpacity}%</span></div></div>
                                    <div className="form-row"><span className="form-label">Text Shadow</span><div className="btn-group"><button className={`btn-group-item ${settings.textShadow ? 'active' : ''}`} onClick={() => updateSetting('textShadow', true)} style={{ width: '40px', fontSize: '10px' }}>On</button><button className={`btn-group-item ${!settings.textShadow ? 'active' : ''}`} onClick={() => updateSetting('textShadow', false)} style={{ width: '40px', fontSize: '10px' }}>Off</button></div></div>
                                </div>
                            </div>
                        </div>

                        <div className="card full-width">
                            <h3 className="card-title">OBS Browser Source URL</h3>
                            <div className="obs-option">
                                <div className="obs-option-header"><span className="obs-option-number">1</span><span className="obs-option-title">Same Computer</span></div>
                                <p className="obs-option-desc">OBS is on this machine</p>
                                <div className="url-row"><input type="text" className="url-input" value={localUrl} readOnly /><button className={`copy-btn ${copiedUrl === 'local' ? 'copied' : ''}`} onClick={() => copyUrl(localUrl, 'local')}>{copiedUrl === 'local' ? 'Copied!' : 'Copy'}</button></div>
                                <div className="obs-settings-row"><span>Width: <strong>1920</strong></span><span>Height: <strong>1080</strong></span></div>
                            </div>
                            <div className="obs-option">
                                <div className="obs-option-header"><span className="obs-option-number">2</span><span className="obs-option-title">Local Network</span></div>
                                <p className="obs-option-desc">OBS on another computer on your WiFi</p>
                                <div className="url-row"><input type="text" className="url-input" value={networkUrl || 'See terminal for IP'} readOnly /><button className={`copy-btn ${copiedUrl === 'net' ? 'copied' : ''}`} onClick={() => copyUrl(networkUrl, 'net')} disabled={!networkUrl}>{copiedUrl === 'net' ? 'Copied!' : 'Copy'}</button></div>
                            </div>
                            <div className="obs-option">
                                <div className="obs-option-header">
                                    <span className="obs-option-number">3</span>
                                    <span className="obs-option-title">Cloud Server</span>
                                    {remoteServer && (
                                        <span style={{ 
                                            marginLeft: 'auto', 
                                            fontSize: '11px', 
                                            padding: '2px 8px', 
                                            borderRadius: '10px',
                                            background: cloudConnected ? '#DEF7EC' : '#FDE8E8',
                                            color: cloudConnected ? '#03543F' : '#9B1C1C',
                                            fontWeight: '600'
                                        }}>
                                            {cloudConnected ? '● Connected' : '○ Not Connected'}
                                        </span>
                                    )}
                                </div>
                                <p className="obs-option-desc">Your DigitalOcean droplet - captions sync automatically</p>
                                <div className="cloud-input-row"><input type="text" className="cloud-input" placeholder="http://your-server.com:8080" value={remoteServer} onChange={e => setRemoteServer(e.target.value)} /></div>
                                {cloudUrl && <div className="url-row"><input type="text" className="url-input" value={cloudUrl} readOnly /><button className={`copy-btn ${copiedUrl === 'cloud' ? 'copied' : ''}`} onClick={() => copyUrl(cloudUrl, 'cloud')}>{copiedUrl === 'cloud' ? 'Copied!' : 'Copy'}</button></div>}
                                {remoteServer && !cloudConnected && (
                                    <p style={{ fontSize: '11px', color: '#9B1C1C', paddingLeft: '24px', marginTop: '6px' }}>
                                        ⚠️ Cannot reach server. Make sure cloud-server.py is running on your droplet and port 8080 is open.
                                    </p>
                                )}
                            </div>
                        </div>
                    </div>

                    <footer className="footer">
                        <p>A community AI project from <a href="https://brooklineinteractive.org" target="_blank" rel="noopener noreferrer">Brookline Interactive Group</a><br/>Designed and developed by <a href="https://weirdmachine.org" target="_blank" rel="noopener noreferrer">Stephen Walter</a></p>
                        <div className="footer-links">
                            <a href="https://github.com/brooklineinteractive/community-captioner" target="_blank" rel="noopener noreferrer" className="footer-link"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>GitHub</a>
                            <span className="footer-link"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M14.31 8l5.74 9.94M9.69 8h11.48M7.38 12l5.74-9.94M9.69 16L3.95 6.06M14.31 16H2.83M16.62 12l-5.74 9.94"/></svg>CC BY-SA 4.0</span>
                        </div>
                    </footer>
                </div>
            );
        }

        function App() { return isOverlayMode() ? <CaptionOverlay /> : <ControlPanel />; }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
